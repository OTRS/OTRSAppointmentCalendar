# --
# Copyright (C) 2001-2016 OTRS AG, http://otrs.com/
# --
# This software comes with ABSOLUTELY NO WARRANTY. For details, see
# the enclosed file COPYING for license information (AGPL). If you
# did not receive this file, see http://www.gnu.org/licenses/agpl.txt.
# --

[% RenderBlockStart("EditMask") %]
<div class="InnerContent">
    <form id="EditAppointmentForm" class="Validate">
        <input type="hidden" id="Action" name="Action" value="[% Env("Action") | html %]"/>
        <input type="hidden" id="Subaction" name="Subaction" value="[% Env("Subaction") | html %]"/>
        <input type="hidden" id="AppointmentID" name="AppointmentID" value="[% Data.AppointmentID | html %]"/>
[% FOREACH ResourceID IN Data.ResourceID %]
        <input type="hidden" id="ResourceID" name="ResourceID[]" value="[% ResourceID | html %]"/>
[% END %]
        <input type="hidden" id="Recurring" name="Recurring" value="[% Data.Recurring | html %]"/>
        <fieldset class="TableLike">
            <legend><span>[% Translate("Basic information") | html %]</span></legend>
            <label class="Mandatory" for="Title"><span class="Marker">*</span> [% Translate("Title") | html %]:</label>
            <div class="Field">
# check if permissions below move_into
[% IF Data.PermissionLevel AND Data.PermissionLevel < 2 %]
                <input type="text" id="Title" name="Title" value="[% Data.Title | html %]" class="W75pc Validate_Required" disabled="disabled" />
[% ELSE %]
                <input type="text" id="Title" name="Title" value="[% Data.Title | html %]" class="W75pc Validate_Required" />
[% END %]
                <div id="TitleError" class="TooltipErrorMessage">
                    <p>[% Translate("This field is required.") | html %]</p>
                </div>
                <div id="TitleServerError" class="TooltipErrorMessage">
                    <p>[% Translate("This field is required.") | html %]</p>
                </div>
            </div>
            <div class="Clear"></div>
            <label for="Description">[% Translate("Description") | html %]:</label>
            <div class="Field">
[% IF Data.PermissionLevel AND Data.PermissionLevel < 2 %]
                <textarea id="Description" name="Description" class="W75pc" rows="4" disabled="disabled" >[% Data.Description | html %]</textarea>
[% ELSE %]
                <textarea id="Description" name="Description" class="W75pc" rows="4">[% Data.Description | html %]</textarea>
[% END %]
            </div>
            <div class="Clear"></div>
            <label for="Location">[% Translate("Location") | html %]:</label>
            <div class="Field">
[% IF Data.PermissionLevel AND Data.PermissionLevel < 2 %]
                <input type="text" id="Location" name="Location" value="[% Data.Location | html %]" class="W50pc" disabled="disabled" />
[% ELSE %]
                <input type="text" id="Location" name="Location" value="[% Data.Location | html %]" class="W50pc" />
[% END %]
            </div>
            <div class="Clear"></div>
            <label for="CalendarID" class="Mandatory"><span class="Marker">*</span> [% Translate("Calendar") | html %]:</label>
            <div class="Field">
                [% Data.CalendarIDStrg %]
                <div id="CalendarIDError" class="TooltipErrorMessage">
                    <p>[% Translate("This field is required.") | html %]</p>
                </div>
                <div id="CalendarIDServerError" class="TooltipErrorMessage">
                    <p>[% Translate("This field is required.") | html %]</p>
                </div>
            </div>
        </fieldset>
[% IF Data.TeamListStrg %]
        <fieldset class="TableLike">
            <legend><span>[% Translate("Resource") | html %]</span></legend>
            <label for="TeamList">[% Translate("Team") | html %]:</label>
            <div class="Field">
                [% Data.TeamListStrg %]
            </div>
            <div class="Clear"></div>
[% FOREACH TeamID IN Data.TeamUserLists.keys %]
            <label for="TeamUserList[% TeamID %]" class="TeamUserListLabel">[% Translate("Agent") | html %]:</label>
            <div class="Field TeamUserList">
                [% Data.TeamUserLists.$TeamID %]
            </div>
[% END %]
        </fieldset>
[% END %]
        <fieldset class="TableLike">
            <legend><span>[% Translate("Date/Time") | html %]</span></legend>
            <label>[% Translate("Start date") | html %]:</label>
            <div class="Field">
                [% Data.StartDateString %]
                <div id="StartDayError" class="TooltipErrorMessage">
                    <p>[% Translate("Please set this to value before End date.") | html %]</p>
                </div>
            </div>
            <div class="Clear"></div>
            <label>[% Translate("End date") | html %]:</label>
            <div class="Field">
                [% Data.EndDateString %]
                <div id="EndDayError" class="TooltipErrorMessage">
                    <p>[% Translate("Please set this to a value after start date.") | html %]</p>
                </div>
            </div>
            <div class="Clear"></div>
            <label for="AllDay">[% Translate("All day") | html %]:</label>
            <div class="Field">
[% IF Data.PermissionLevel AND Data.PermissionLevel < 2 %]
                <input type="checkbox" id="AllDay" name="AllDay" [% Data.AllDayChecked %] disabled="disabled" />
[% ELSE %]
                <input type="checkbox" id="AllDay" name="AllDay" [% Data.AllDayChecked %] />
[% END %]
            </div>
            <div class="Clear"></div>
            <label for="RecurrenceType">[% Translate("Repeat") | html %]:</label>
            <div class="Field">
                [% Data.RecurrenceTypeString %]
            </div>
            <div id="RecurrenceLimitDiv" class="Field Hidden">
                [% Data.RecurrenceLimitString %]
            </div>
            <div id="RecurrenceUntilDiv" class="Field Hidden">
                [% Data.RecurrenceUntilString %]
                <div id="RecurrenceUntilDayError" class="TooltipErrorMessage">
                    <p>[% Translate("Please set this to value after start date.") | html %]</p>
                </div>
            </div>
            <div id="RecurrenceCountDiv" class="Field Hidden">
                <input type="text" id="RecurrenceCount" name="RecurrenceCount" value="[% Data.RecurrenceCount | html %]" size="1" maxlength="2" />
            </div>
        </fieldset>
[% IF Data.PluginListStrg %]
        <fieldset class="TableLike">
            <legend><span>[% Translate("Link") | html %]</span></legend>
[% FOREACH Key IN Data.PluginData.keys %]
            <label for="Plugin_[% Key | html %]">[% Translate(Data.PluginData.$Key.Name) | html %]:</label>
            <div class="Field">
[% IF Data.PermissionLevel AND Data.PermissionLevel < 2 %]
                <input type="text" id="Plugin_[% Key | html %]" name="Plugin_[% Key | html %]" value="[% Data.PluginData.$Key.Value | html %]" class="PluginField W75pc" disabled="disabled" />
[% ELSE %]
                <input type="text" id="Plugin_[% Key | html %]" name="Plugin_[% Key | html %]" value="[% Data.PluginData.$Key.Value | html %]" class="PluginField W75pc" />
                <a class="RemoveButton" data-plugin="Plugin_[% Key | html %]" href="#" title="[% Translate("Remove entry") | html %]"><i class="fa fa-minus-square-o"></i><span class="InvisibleText">[% Translate("Remove") | html %]</span></a>
[% END %]
            </div>
[% END %]
            <label id="PluginListLabel" for="PluginList">[% Translate("Add") | html %]:</label>
            <div class="Field">
                [% Data.PluginListStrg %]
[% IF !Data.PermissionLevel OR Data.PermissionLevel > 1 %]
                <a class="AddButton" href="#" title="[% Translate("Add entry") | html %]"><i class="fa fa-plus-square-o"></i><span class="InvisibleText">[% Translate("Add") | html %]</span></a>
[% END %]
            </div>
            <div class="Clear"></div>
        </fieldset>
[% END %]
    </form>
</div>

<div class="ContentFooter Center">
[% IF Data.AppointmentID AND Data.PermissionLevel > 2 %]
    <button id="EditFormCopy" class="Primary CallForAction" value="[% Translate("Copy") | html %]"><span><i class="fa fa-files-o"></i> [% Translate("Copy") | html %]</span></button>
[% END %]
[% IF !Data.PermissionLevel OR Data.PermissionLevel > 1 %]
    <button id="EditFormSubmit" class="Primary CallForAction" value="[% Translate("Save") | html %]"><span><i class="fa fa-check-square-o"></i> [% Translate("Save") | html %]</span></button>
[% END %]
[% IF Data.AppointmentID AND Data.PermissionLevel > 2 %]
    <button id="EditFormDelete" class="CallForAction"><span>[% Translate("Delete") | html %]</span></button>
[% END %]
    <button id="EditFormCancel" class="CallForAction"><span>[% Translate("Cancel") | html %]</span></button>
</div>

<script type="text/javascript">//<![CDATA[

Core.Form.Validate.Init();
Core.Agent.AppointmentCalendar.AllDayInit($('#AllDay'));
Core.Agent.AppointmentCalendar.RecurringInit({
    $Recurring: $('#Recurring'),
    $RecurrenceType: $('#RecurrenceType'),
    $RecurrenceLimitDiv: $('#RecurrenceLimitDiv'),
    $RecurrenceLimit: $('#RecurrenceLimit'),
    $RecurrenceUntilDiv: $('#RecurrenceUntilDiv'),
    $RecurrenceCountDiv: $('#RecurrenceCountDiv'),
});
Core.Agent.AppointmentCalendar.TeamInit($('#TeamList'));
[% IF !Data.PermissionLevel OR Data.PermissionLevel > 1 %]
Core.Agent.AppointmentCalendar.PluginInit($('#PluginList'), $('.AddButton'));
[% END %]

Core.Form.Validate.SetSubmitFunction($('#EditAppointmentForm'), function (Form) {
    var Data = new Object();

    $(Form).find('input,textarea,select').each(function (Index, Element) {
        if (Element.type == 'checkbox') {
            Data[Element.id] = $(Element).prop('checked') ? '1' : '0';
        } else {
            Data[Element.id] = $(Element).val();
        }
    });

[% IF Data.AppointmentID %]

    // Edit the appointment
    Data.Subaction = 'EditAppointment';
    Core.Agent.AppointmentCalendar.EditAppointment(Data);

[% ELSE %]

    // Add the appointment
    Data.Subaction = 'AddAppointment';
    Core.Agent.AppointmentCalendar.EditAppointment(Data);

[% END %]

});

// Duplicate appointment
$('#EditFormCopy').on('click', function() {
    var Title = $(".Dialog:visible h1").html();

    // Update title
    Title += " " + Core.Language.Translate('Copy');
    $(".Dialog:visible h1").html(Title);

    // Reset AppointmentID, remove Copy & Delete buttons
    $("#EditAppointmentForm input#AppointmentID").val("");
    $("#EditFormCopy").remove();
    $("#EditFormDelete").remove();
});

// Save the appointment
$('#EditFormSubmit').on('click', function() {
    $('#EditAppointmentForm').submit();
});

[% IF Data.AppointmentID %]

// Delete the appointment
$('#EditFormDelete').on('click', function() {
    Core.Agent.AppointmentCalendar.EditAppointment({
        CalendarID: [% Data.CalendarID | JSON %],
        AppointmentID: $('input[name="AppointmentID"]').val(),
        Action: 'AgentAppointmentEdit',
        Subaction: 'DeleteAppointment'
    });
});

[% END %]

// Close the dialog
$('#EditFormCancel').on('click', function() {
    Core.UI.Dialog.CloseDialog($('.Dialog:visible'));
});

//]]></script>
[% RenderBlockEnd("EditMask") %]
